<html>
<style>
td, th {
  border: 1px solid black;
}
</style>
TODO: dynamic html table creation<br/>
<br/>
<h2>Load local tune file:</h2>
<input type="file" id="file-input" /><br/>
<a href="https://raw.githubusercontent.com/noisymime/speeduino/master/reference/Base%20Tunes/Speeduino%20base%20tune.msq">(Download base tune file to test local file open/load with)</a><br/>
<br/>

<h2>Load from URL/internet</h2>
<input id="fileUrl" type="text" value="https://raw.githubusercontent.com/noisymime/speeduino/master/reference/Base%20Tunes/Speeduino%20base%20tune.msq">
<input type="button" onclick="loadFileUrlButton();" value="Load">
<br/>
<br/>

<h2>Save to new file</h2>
<input type="button" onclick="saveNewFile();" value="save">
<br/>
<br/>
<br/>

<hr/>

<h2>veTable</h2>
<div id="veTableUnits"></div>
<div id="veTable_wrapper"></div>
<!-- <table id="veTable">
  <tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr>

  <tr><th></th>  <td id="veTable_0_0"></td><td id="veTable_0_1"></td><td  id="veTable_0_2"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  <tr><th></th>  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
</table> -->
<br/>

<hr/>

<h2>advTable1</h2>
<div id="advTable1Units"></div>
<div id="advTable1_wrapper"></div>
<br/>

<hr/>

<h2>afrTable</h2>
<div id="afrTableUnits"></div>
<div id="afrTable_wrapper"></div>
<br/>

<hr/>

<h2>boostTable</h2>
<div id="boostTableUnits"></div>
<div id="boostTable_wrapper"></div>
<br/>

<hr/>

<h2>vvtTable</h2>
<div id="vvtTableUnits"></div>
<div id="vvtTable_wrapper"></div>

<script type="text/javascript">


document.getElementById('file-input')
  .addEventListener('change', readSingleFile, false);

document.querySelectorAll('td')
.forEach(e => e.addEventListener("click", function() {
    console.log("clicked")
    console.log(this);
}));


// debug - auto load a tune file
loadFromUrl("https://raw.githubusercontent.com/noisymime/speeduino/master/reference/Base%20Tunes/Speeduino%20base%20tune.msq");


// file open function:
function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    // displayContents(contents);
    parse(contents);

  };
  reader.readAsText(file);
}


function loadFileUrlButton() {
  fileUrlTextBox = document.getElementById("fileUrl");
  loadFromUrl(fileUrlTextBox.value);
}

function loadFromUrl(url) {
  fetch(url)
  .then(
    function(response) {
      if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
          response.status);
        return;
      }
      response.text().then(function (text) {
          parse(text);
      });
    }
  )
  .catch(function(err) {
    console.log('Fetch Error :-S', err);
  });
}

function percentColourCell(tableCell, percent) {
  // TODO: do as classes/css
  if (percent > 80) { bg = "red"; color = "white";}
  else if (percent > 60) { bg = "yellow"; color = "black";}
  else if (percent > 40) { bg = "orange"; color = "black";}
  else              { bg = "blue"; color = "white";}

  tableCell.style.background = bg;
  tableCell.style.color = color;
}



function parse(text) {

  parser = new DOMParser();
  xml = parser.parseFromString(text,"text/xml");

  window.xml = xml;
  console.log(xml);

  userComments = xml.getElementsByTagName("userComments");
  pages = xml.getElementsByTagName("page");
  getBibliography();

  getAndOutputTable("veTable", "rpmBins", "fuelLoadBins");

  getAndOutputTable("advTable1", "rpmBins2", "mapBins1");

  getAndOutputTable("afrTable", "rpmBinsAFR", "loadBinsAFR");

  getAndOutputTable("boostTable", "rpmBinsBoost", "tpsBinsBoost");

  getAndOutputTable("vvtTable", "rpmBinsVVT", "loadBinsVVT");
}


function getBibliography() {
  bibliography = xml.getElementsByTagName("bibliography")[0];
  writeDate = bibliography.getAttribute("writeDate");
  // console.log("tune write date:"+writeDate);
  author = bibliography.getAttribute("author");
  // console.log("author:"+author);
  tuneComment = bibliography.getAttribute("tuneComment");
  // console.log("comment:"+tuneComment);
}


function createTable(name) {
  wrapper = document.getElementById(name+"_wrapper");
  console.log("creating table");


  newTable = document.createElement("TABLE");
  wrapper.appendChild(newTable);
  newTable.id = name;

  headerRow = document.createElement("TR");
  newTable.appendChild(headerRow);

  headerRow.appendChild(document.createElement("TH")); // empty top corner
  for (var i=0; i<16; i++) {
    var th = document.createElement("TH");
    th.id = name+"_colHeader_"+i;
    headerRow.appendChild(th); // headers
  }

  // rest of rows
  for (var i=0; i<16; i++) {
    newRow = document.createElement("TR");
    newTable.appendChild(newRow);

    var th = document.createElement("TH");
    th.id = name+"_rowHeader_"+i;
    newRow.appendChild(th);

    for (var j=0; j<16; j++) {
      var newCell = document.createElement("TD");
      newCell.id = name+"_"+i+"_"+j;
      newRow.appendChild(newCell);
    }
  }
}


function getAndOutputTable(mainData, colHeader, rowHeader) {
  createTable(mainData);

  // TODO: anon the var names in here
  tableDiv = document.getElementById(mainData);
  veTableUnitsDiv = document.getElementById(mainData+"Units");

  rpmBins = getTable(colHeader);
  for (x in rpmBins["data"]) {
    for (y in rpmBins["data"][x]) {
      tableCell = document.getElementById(mainData+"_colHeader_"+x);
      tableCell.innerText = rpmBins["data"][x][y];
    }
  }

  fuelLoadBins = getTable(rowHeader);
  // console.log(fuelLoadBins);
  for (rowNum in fuelLoadBins["data"]) {
    for (cellNum in fuelLoadBins["data"][rowNum]) {
      tableCell = document.getElementById(mainData+"_rowHeader_"+rowNum);
      tableCell.innerText = fuelLoadBins["data"][rowNum][cellNum];
    }
  }

  veTable = getTable(mainData);

  // get min and max for percentage/colouring
  var minValue = 99999;
  var maxValue = -99999;
  for (rowNum in veTable["data"]) {
    for (cellNum in veTable["data"][rowNum]) {
      var cellValue = parseInt(veTable["data"][rowNum][cellNum]);
      if (cellValue > maxValue) {
        maxValue = cellValue;
      }
      if (cellValue < minValue) {
        minValue = cellValue;
      }
    }
  }
  var valueRange = maxValue - minValue;

  for (rowNum in veTable["data"]) {
    for (cellNum in veTable["data"][rowNum]) {
      tableCell = document.getElementById(mainData+"_"+rowNum+"_"+cellNum);
      cellValue = veTable["data"][rowNum][cellNum];
      tableCell.innerText = cellValue;
      cellPercent = ((cellValue-minValue)/valueRange)*100;
      percentColourCell(tableCell, cellPercent);
    }
  }

  veTableUnitsDiv.innerText = veTable["units"]+" as "+fuelLoadBins["units"]+" vs "+rpmBins["units"];

}



function getTable(name) {
  element = xml.getElementsByName(name)[0];
  // console.log(element);
  output = {};
  output["name"] = element.getAttribute("name");
  output["digits"] = element.getAttribute("digits");
  output["cols"] = element.getAttribute("cols");
  output["rows"] = element.getAttribute("rows");
  output["units"] = element.getAttribute("units");
  output["data"] = [];
  rows = element.textContent.split("\n");
  // random whitespace was in tune file (is it random?)
  newRows = [];
  for (rowNum in rows) {
    var row = rows[rowNum];
    row = row.trim();
    if (row != "") {
      var cells = row.split(" ");
      output["data"].push(cells);
    }
  }
  return output;
}


function saveNewFile() {
  console.log(xml.documentElement.outerHTML);
  downloadTextAsFile(xml.documentElement.outerHTML, "tune.msq");

}

function downloadTextAsFile(text, filename) {
  // only non-whitespace diff at the moment is:
  // < <?xml version="1.0" encoding="ISO-8859-1"?>
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);
  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}

</script>

</html>
